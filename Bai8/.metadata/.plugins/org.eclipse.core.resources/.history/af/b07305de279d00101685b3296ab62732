<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Little Lotus Bookstore - Products</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container my-5">
    <h1 class="text-center mb-4 text-secondary">Little Lotus Products <span style="font-size: 0.7em;">ðŸŒ¸</span></h1>
    <div class="row" id="product-list">
        </div>
</div>

<script>
    $(document).ready(function() {
        function fetchProducts() {
            // GraphQL Query (YÃªu cáº§u 1: Hiá»ƒn thá»‹ product cÃ³ price tá»« tháº¥p Ä‘áº¿n cao)
            const graphqlQuery = {
                query: `
                    query {
                        productsByPriceAsc {
                            id
                            title
                            price
                            quantity
                            category {
                                name
                            }
                        }
                    }
                `
            };

            $.ajax({
                url: '/graphql', 
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(graphqlQuery),
                success: function(response) {
                    if (response.data && response.data.productsByPriceAsc) {
                        renderProducts(response.data.productsByPriceAsc);
                    } else {
                        $('#product-list').html('<p class="text-danger">KhÃ´ng láº¥y Ä‘Æ°á»£c dá»¯ liá»‡u sáº£n pháº©m.</p>');
                    }
                },
                error: function(xhr, status, error) {
                    console.error("GraphQL Request Failed: ", status, error, xhr.responseText);
                    $('#product-list').html('<p class="text-danger">Lá»—i káº¿t ná»‘i API. Vui lÃ²ng kiá»ƒm tra console log.</p>');
                }
            });
        }

        // HÃ m render dá»¯ liá»‡u lÃªn view
        function renderProducts(products) {
            let htmlContent = '';
            
            if (products.length === 0) {
                htmlContent = '<p class="text-center col-12">ChÆ°a cÃ³ sáº£n pháº©m nÃ o Ä‘Æ°á»£c bÃ¡n.</p>';
            }
            
            products.forEach(product => {
                // ... (pháº§n render HTML giá»¯ nguyÃªn)
                htmlContent += `
                    <div class="col-md-4 mb-4">
                        <div class="card shadow-sm h-100">
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title text-success">${product.title}</h5>
                                <p class="card-text">
                                    <strong>GiÃ¡:</strong> ${product.price.toLocaleString('vi-VN')} VND
                                </p>
                                <p class="card-text">
                                    <strong>Sá»‘ lÆ°á»£ng:</strong> ${product.quantity}
                                </p>
                                <p class="card-text mt-auto"><small class="text-muted">Danh má»¥c: ${product.category.name}</small></p>
                                <a href="#" class="btn btn-sm btn-outline-info mt-2">Xem chi tiáº¿t</a>
                            </div>
                        </div>
                    </div>
                `;
            });
            $('#product-list').html(htmlContent);
        }

        fetchProducts();
    });
</script>
</body>
</html>