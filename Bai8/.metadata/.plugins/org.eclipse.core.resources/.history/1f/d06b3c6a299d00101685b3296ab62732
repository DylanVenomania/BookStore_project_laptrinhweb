<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Little Lotus Bookstore - Products</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container my-5">
    <h1 class="text-center mb-4 text-secondary">Little Lotus Products <span style="font-size: 0.7em;">üå∏</span></h1>
    <div class="row" id="product-list">
        </div>
</div>

<script>
    $(document).ready(function() {
        function fetchProducts() {
            // GraphQL Query 
            const graphqlQuery = {
                query: `
                    query {
                        productsByPriceAsc {
                            id
                            title
                            price
                            quantity
                            category {
                                name
                            }
                        }
                    }
                `
            };

            $.ajax({
                url: '/graphql', 
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(graphqlQuery),
                success: function(response) {
                    if (response.data && response.data.productsByPriceAsc) {
                        // G·ªçi h√†m render
                        renderProducts(response.data.productsByPriceAsc);
                    } else {
                        console.error("D·ªØ li·ªáu GraphQL tr·∫£ v·ªÅ kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng.", response);
                        $('#product-list').html('<p class="text-danger">Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu s·∫£n ph·∫©m.</p>');
                    }
                },
                error: function(xhr, status, error) {
                    console.error("GraphQL Request Failed: ", status, error, xhr.responseText);
                    $('#product-list').html('<p class="text-danger">L·ªói k·∫øt n·ªëi API. Vui l√≤ng ki·ªÉm tra console log.</p>');
                }
            });
        }

        function renderProducts(products) {
            let htmlContent = '';
            
            if (!products || products.length === 0) {
                htmlContent = '<p class="text-center col-12">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o ƒë∆∞·ª£c b√°n.</p>';
                $('#product-list').html(htmlContent);
                return;
            }
            
            products.forEach(product => {
                // S·ª¨A L·ªñI: S·ª≠ d·ª•ng to√°n t·ª≠ nullish coalescing (??) ho·∫∑c OR (||) 
                // ƒë·ªÉ g√°n gi√° tr·ªã m·∫∑c ƒë·ªãnh, ngƒÉn l·ªói undefined/null khi render.
                const title = product.title || "Kh√¥ng r√µ ti√™u ƒë·ªÅ";
                const quantity = product.quantity !== null && product.quantity !== undefined ? product.quantity : 0;
                const categoryName = (product.category && product.category.name) ? product.category.name : "Kh√¥ng r√µ danh m·ª•c";
                
                // √âp ki·ªÉu v√† ƒë·ªãnh d·∫°ng gi√° (r·∫•t quan tr·ªçng)
                const priceValue = product.price || 0;
                const formattedPrice = Number(priceValue).toLocaleString('vi-VN');
                
                htmlContent += `
                    <div class="col-md-4 mb-4">
                        <div class="card shadow-sm h-100">
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title text-success">${title}</h5>
                                <p class="card-text">
                                    <strong>Gi√°:</strong> ${formattedPrice} VND
                                </p>
                                <p class="card-text">
                                    <strong>S·ªë l∆∞·ª£ng:</strong> ${quantity}
                                </p>
                                <p class="card-text mt-auto"><small class="text-muted">Danh m·ª•c: ${categoryName}</small></p>
                                <a href="#" class="btn btn-sm btn-outline-info mt-2">Xem chi ti·∫øt</a>
                            </div>
                        </div>
                    </div>
                `;
            });
            $('#product-list').html(htmlContent);
        }

        fetchProducts();
    });
</script>
</body>
</html>